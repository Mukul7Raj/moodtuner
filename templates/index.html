<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Emotion-Based Music Recommender</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.8/dist/purify.min.js"></script>
</head>
<body class="dark-theme">
  <div class="container">
    <header class="header">
      <img src="{{ url_for('static', filename='josh_emo_musics_logo.png') }}" alt="JOSH Emo Musics Logo" class="logo">
      <h1>Emotion-Based Music Recommender</h1>
      <div class="header-controls">
        <div class="focus-timer">
          <h4 class="timer-heading">Focus Mode Timer: <span id="total-time">0:00:00</span></h4>
          <button id="play-pause" aria-label="Start or pause timer"><i class="fas fa-play"></i> Start</button>
          <button id="reset-timer" aria-label="Reset timer"><i class="fas fa-redo"></i> Reset</button>
        </div>
        <div class="header-buttons">
          <button id="theme-toggle" aria-label="Toggle theme"><i class="fas fa-adjust"></i> Theme</button>
          <button id="todo-toggle" aria-label="Open To-Do panel"><i class="fas fa-tasks"></i> To-Do</button>
        </div>
      </div>
    </header>
    <main class="main-content">
      <section class="left-section">
        <div class="search-section">
          <h2><i class="fas fa-search"></i> Search Music</h2>
          <div class="search-input">
            <input type="text" id="search-input" placeholder="Search for a song or artist..." aria-label="Search for music">
            <button id="search-button" aria-label="Search"><i class="fas fa-search"></i></button>
          </div>
          <button id="voice-search" aria-label="Start voice search"><i class="fas fa-microphone"></i> Voice Search</button>
        </div>
        <div class="webcam-section">
          <h2><i class="fas fa-camera"></i> Your Webcam Feed</h2>
          <div class="camera-controls">
            <button id="start-camera" aria-label="Start webcam"><i class="fas fa-play"></i> Start Camera</button>
            <button id="capture-image" style="display: none;" aria-label="Capture image for emotion detection"><i class="fas fa-camera-retro"></i> Capture Image</button>
            <select id="manual-emotion" style="display: none;" aria-label="Manually select emotion">
              <option value="" disabled selected>Select an emotion</option>
              <option value="angry">Angry</option>
              <option value="disgust">Disgust</option>
              <option value="fear">Fear</option>
              <option value="happy">Happy</option>
              <option value="sad">Sad</option>
              <option value="surprise">Surprise</option>
              <option value="neutral">Neutral</option>
            </select>
          </div>
          <div class="webcam-container">
            <img id="video-feed" src="" alt="Webcam Feed" style="display: none;">
            <img id="face-logo" src="{{ url_for('static', filename='face_logo.png') }}" alt="Webcam Placeholder">
          </div>
          <div class="loading-spinner" style="display: none;">Loading...</div>
        </div>
        <div class="result-section" style="display: none;">
          <h2><i class="fas fa-smile"></i> Detected Mood: <span id="emotion">None</span> (Class: <span id="emotion-class">None</span>)</h2>
        </div>
        <div class="emotion-history" style="display: none;">
          <h2><i class="fas fa-chart-bar"></i> Emotion History</h2>
          <button id="reset-emotion-history" aria-label="Reset emotion history"><i class="fas fa-redo"></i> Reset History</button>
          <canvas id="emotion-chart" aria-label="Emotion history chart"></canvas>
        </div>
      </section>
      <section class="right-section">
        <div class="player-section" style="display: none;">
          <h2><i class="fas fa-music"></i> Currently Playing Song</h2>
          <div class="player-box">
            <iframe id="music-player" width="100%" height="200" src="" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
            <div class="player-info">
              <h3 id="song-title">No song playing</h3>
              <p id="autoplay-notice" style="display: none; color: #ffeb3b; font-size: 0.9em;">
                Note: Autoplay may be blocked by your browser. Please click the play button in the player above to start the song.
              </p>
            </div>
          </div>
        </div>
        <div class="video-list" style="display: none;">
          <h2><i class="fas fa-list-ul"></i> Recommended Songs</h2>
          <div class="youtube-results">
            <h3>YouTube Results</h3>
            <ul id="youtube-video-list"></ul>
          </div>
          <div class="spotify-results">
            <h3>Spotify Results</h3>
            <ul id="spotify-track-list"></ul>
          </div>
        </div>
        <div class="search-results" style="display: none;">
          <h2><i class="fas fa-search"></i> Search Results</h2>
          <div class="youtube-results">
            <h3>YouTube Results</h3>
            <ul id="youtube-search-results"></ul>
          </div>
          <div class="spotify-results">
            <h3>Spotify Results</h3>
            <ul id="spotify-search-results"></ul>
          </div>
        </div>
        <div class="liked-videos" style="{% if not liked_videos %}display: none;{% endif %}">
          <h2><i class="fas fa-heart"></i> My Liked Songs</h2>
          <ul id="liked-videos">
            {% for video in liked_videos %}
              <li>
                <a href="{{ video.embed_link }}" target="_blank" aria-label="Play {{ video.title }}">{{ video.title }}</a>
              </li>
            {% endfor %}
          </ul>
        </div>
      </section>
      <aside class="todo-panel" id="todo-panel">
        <div class="todo-header">
          <h2><i class="fas fa-tasks"></i> To-Do List</h2>
          <button id="todo-close" aria-label="Close To-Do Panel"><i class="fas fa-times"></i></button>
        </div>
        <div class="todo-input-section">
          <h2><i class="fas fa-tasks"></i> To-Do</h2>
          <div class="todo-input">
            <input type="text" id="todo-input" placeholder="Add a new task..." aria-label="Add a new task">
            <button id="todo-add" aria-label="Add Task"><i class="fas fa-plus"></i></button>
          </div>
        </div>
        <ul id="todo-list"></ul>
      </aside>
    </main>
  </div>

  <script>
    // Global variables
    const elements = {
      videoFeed: document.getElementById('video-feed'),
      faceLogo: document.getElementById('face-logo'),
      startButton: document.getElementById('start-camera'),
      captureButton: document.getElementById('capture-image'),
      manualEmotion: document.getElementById('manual-emotion'),
      voiceSearchButton: document.getElementById('voice-search'),
      searchInput: document.getElementById('search-input'),
      searchButton: document.getElementById('search-button'),
      musicPlayer: document.getElementById('music-player'),
      playPauseButton: document.getElementById('play-pause'),
      totalTimeDisplay: document.getElementById('total-time'),
      resetTimerButton: document.getElementById('reset-timer'),
      todoPanel: document.getElementById('todo-panel'),
      todoToggle: document.getElementById('todo-toggle'),
      todoClose: document.getElementById('todo-close'),
      todoInput: document.getElementById('todo-input'),
      todoAdd: document.getElementById('todo-add'),
      todoList: document.getElementById('todo-list'),
      autoplayNotice: document.getElementById('autoplay-notice'),
      resetEmotionHistory: document.getElementById('reset-emotion-history'),
      loadingSpinner: document.querySelector('.loading-spinner')
    };
    let isPlaying = false;
    let currentVideoIndex = 0;
    let videos = [];
    let totalTime = parseInt(localStorage.getItem('totalTime')) || 0;
    let timerInterval;
    let timerRunning = false;
    let emotionHistory = JSON.parse(localStorage.getItem('emotionHistory')) || [];
    let emotionChart;

    // Emotion Chart
    function initializeEmotionChart() {
      const ctx = document.getElementById('emotion-chart').getContext('2d');
      const emotionCounts = {};
      ['angry', 'disgust', 'fear', 'happy', 'sad', 'surprise', 'neutral'].forEach(emotion => {
        emotionCounts[emotion] = 0;
      });
      emotionHistory.forEach(entry => emotionCounts[entry.emotion]++);

      emotionChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(emotionCounts),
          datasets: [{
            label: 'Emotion Frequency',
            data: Object.values(emotionCounts),
            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF'],
            borderColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF'],
            borderWidth: 1
          }]
        },
        options: {
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Frequency' } },
            x: { title: { display: true, text: 'Emotion' } }
          },
          plugins: { legend: { display: false }, tooltip: { enabled: true } }
        }
      });
    }

    function updateEmotionChart(emotion) {
      emotionHistory = emotionHistory.slice(-100); // Limit to last 100 entries
      emotionHistory.push({ emotion, timestamp: Date.now() });
      localStorage.setItem('emotionHistory', JSON.stringify(emotionHistory));
      const emotionCounts = {};
      ['angry', 'disgust', 'fear', 'happy', 'sad', 'surprise', 'neutral'].forEach(emotion => {
        emotionCounts[emotion] = 0;
      });
      emotionHistory.forEach(entry => emotionCounts[entry.emotion]++);
      emotionChart.data.datasets[0].data = Object.values(emotionCounts);
      emotionChart.update();
    }

    function resetEmotionHistory() {
      emotionHistory = [];
      localStorage.setItem('emotionHistory', JSON.stringify(emotionHistory));
      updateEmotionChart('none');
      document.querySelector('.emotion-history').style.display = 'none';
    }

    // Focus Timer
    function updateTimer() {
      totalTime++;
      localStorage.setItem('totalTime', totalTime);
      const hours = Math.floor(totalTime / 3600);
      const minutes = Math.floor((totalTime % 3600) / 60);
      const seconds = totalTime % 60;
      elements.totalTimeDisplay.innerText = `${hours}:${minutes < 10 ? '0' : ''}${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
    }

    function startTimer() {
      if (!timerRunning) {
        timerInterval = setInterval(updateTimer, 1000);
        timerRunning = true;
        elements.playPauseButton.innerHTML = '<i class="fas fa-pause"></i> Pause';
        elements.playPauseButton.classList.add('glow');
      }
    }

    function stopTimer() {
      if (timerRunning) {
        clearInterval(timerInterval);
        timerRunning = false;
        elements.playPauseButton.innerHTML = '<i class="fas fa-play"></i> Start';
        elements.playPauseButton.classList.remove('glow');
      }
    }

    function resetTimer() {
      stopTimer();
      totalTime = 0;
      localStorage.setItem('totalTime', totalTime);
      updateTimer();
    }

    elements.playPauseButton.addEventListener('click', () => timerRunning ? stopTimer() : startTimer());
    elements.resetTimerButton.addEventListener('click', resetTimer);

    // To-Do List
    function loadTodos() {
      const todos = JSON.parse(localStorage.getItem('todos')) || [];
      elements.todoList.innerHTML = '';
      todos.forEach((taskObj, index) => {
        const task = typeof taskObj === 'string' ? { text: taskObj, completed: false } : taskObj;
        const li = document.createElement('li');
        li.innerHTML = `
          <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''} aria-label="Toggle task completion for ${task.text}">
          <span class="task-text" contenteditable="false" style="${task.completed ? 'text-decoration: line-through;' : ''}">${DOMPurify.sanitize(task.text)}</span>
          <div class="task-actions">
            <button class="edit-task" aria-label="Edit task"><i class="fas fa-edit"></i></button>
            <button class="delete-task" aria-label="Delete task"><i class="fas fa-trash"></i></button>
          </div>
        `;
        elements.todoList.appendChild(li);

        li.querySelector('.task-checkbox').addEventListener('change', (e) => {
          const taskText = li.querySelector('.task-text');
          taskText.style.textDecoration = e.target.checked ? 'line-through' : 'none';
          todos[index] = { text: taskText.innerText, completed: e.target.checked };
          localStorage.setItem('todos', JSON.stringify(todos));
        });

        li.querySelector('.edit-task').addEventListener('click', () => {
          const taskText = li.querySelector('.task-text');
          if (taskText.isContentEditable) {
            taskText.contentEditable = false;
            taskText.classList.remove('editing');
            todos[index].text = DOMPurify.sanitize(taskText.innerText);
            localStorage.setItem('todos', JSON.stringify(todos));
          } else {
            taskText.contentEditable = true;
            taskText.classList.add('editing');
            taskText.focus();
          }
        });

        li.querySelector('.delete-task').addEventListener('click', () => {
          todos.splice(index, 1);
          localStorage.setItem('todos', JSON.stringify(todos));
          loadTodos();
        });
      });
    }

    elements.todoAdd.addEventListener('click', () => {
      const task = DOMPurify.sanitize(elements.todoInput.value.trim());
      if (task) {
        const todos = JSON.parse(localStorage.getItem('todos')) || [];
        todos.push({ text: task, completed: false });
        localStorage.setItem('todos', JSON.stringify(todos));
        elements.todoInput.value = '';
        loadTodos();
      }
    });

    elements.todoInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') elements.todoAdd.click();
    });

    elements.todoToggle.addEventListener('click', () => elements.todoPanel.classList.add('open'));
    elements.todoClose.addEventListener('click', () => elements.todoPanel.classList.remove('open'));

    // Webcam
    elements.startButton.addEventListener('click', () => {
      elements.videoFeed.src = '';
      elements.loadingSpinner.style.display = 'block';
      fetch('/start_camera', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          elements.loadingSpinner.style.display = 'none';
          if (data.status === 'success') {
            elements.videoFeed.src = `${window.location.origin}/video_feed?t=${new Date().getTime()}`;
            elements.videoFeed.style.display = 'block';
            elements.faceLogo.style.display = 'none';
            elements.startButton.style.display = 'none';
            elements.captureButton.style.display = 'inline-block';
            elements.manualEmotion.style.display = 'none';
          } else {
            alert(data.message);
            elements.manualEmotion.style.display = 'inline-block';
          }
        })
        .catch(error => {
          elements.loadingSpinner.style.display = 'none';
          console.error('Error starting camera:', error);
          alert('Failed to start camera. Please try again or select an emotion manually.');
          elements.manualEmotion.style.display = 'inline-block';
        });
    });

    elements.captureButton.addEventListener('click', () => {
      elements.loadingSpinner.style.display = 'block';
      fetch('/capture_image', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          elements.loadingSpinner.style.display = 'none';
          if (data.status === 'success') {
            updateUI(data);
            updateEmotionChart(data.emotion);
            elements.emotionHistory.style.display = 'block';
          } else {
            alert(data.message);
            resetWebcam();
            elements.manualEmotion.style.display = 'inline-block';
          }
        })
        .catch(error => {
          elements.loadingSpinner.style.display = 'none';
          console.error('Error capturing image:', error);
          alert('Failed to capture image. Please try again or select an emotion manually.');
          resetWebcam();
          elements.manualEmotion.style.display = 'inline-block';
        });
    });

    elements.manualEmotion.addEventListener('change', () => {
      const emotion = elements.manualEmotion.value;
      if (emotion) {
        elements.loadingSpinner.style.display = 'block';
        fetch('/search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query: `${emotion} music playlist` })
        })
          .then(response => response.json())
          .then(data => {
            elements.loadingSpinner.style.display = 'none';
            if (data.status === 'success') {
              updateUI({ emotion, youtube_videos: data.youtube_videos, spotify_tracks: data.spotify_tracks });
              updateEmotionChart(emotion);
              elements.emotionHistory.style.display = 'block';
            } else {
              alert(data.message);
            }
          })
          .catch(error => {
            elements.loadingSpinner.style.display = 'none';
            console.error('Error with manual emotion:', error);
            alert('Failed to fetch music for selected emotion.');
          });
      }
    });

    function resetWebcam() {
      elements.videoFeed.src = '';
      elements.videoFeed.style.display = 'none';
      elements.faceLogo.style.display = 'block';
      elements.startButton.style.display = 'inline-block';
      elements.captureButton.style.display = 'none';
    }

    // Voice Search
    elements.voiceSearchButton.addEventListener('click', () => {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        alert('Voice search is not supported in your browser. Please use the search bar.');
        return;
      }

      const recognition = new SpeechRecognition();
      recognition.lang = 'en-US';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.start();
      elements.voiceSearchButton.innerHTML = '<i class="fas fa-microphone"></i> Listening...';
      elements.voiceSearchButton.disabled = true;

      recognition.onresult = (event) => {
        const transcript = DOMPurify.sanitize(event.results[0][0].transcript);
        elements.searchInput.value = transcript;
        performSearch(transcript);
        resetVoiceSearch();
      };

      recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        resetVoiceSearch();
        if (event.error === 'no-speech') {
          alert('No speech detected. Please try again.');
        } else if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
          alert('Microphone access denied. Please allow microphone access in your browser settings.');
        } else {
          alert(`Voice search failed: ${event.error}. Please try again.`);
        }
      };

      recognition.onend = resetVoiceSearch;

      function resetVoiceSearch() {
        elements.voiceSearchButton.innerHTML = '<i class="fas fa-microphone"></i> Voice Search';
        elements.voiceSearchButton.disabled = false;
      }
    });

    // Search
    elements.searchButton.addEventListener('click', () => {
      const query = DOMPurify.sanitize(elements.searchInput.value.trim());
      if (query) performSearch(query);
      else alert('Please enter a search query.');
    });

    elements.searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') elements.searchButton.click();
    });

    function performSearch(query) {
      elements.loadingSpinner.style.display = 'block';
      fetch('/search', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query })
      })
        .then(response => response.json())
        .then(data => {
          elements.loadingSpinner.style.display = 'none';
          if (data.status === 'success') {
            displaySearchResults(data);
          } else {
            alert(data.message);
          }
        })
        .catch(error => {
          elements.loadingSpinner.style.display = 'none';
          console.error('Error performing search:', error);
          alert('Failed to perform search. Please try again.');
        });
    }

    function displaySearchResults(data) {
      const youtubeSearchList = document.getElementById('youtube-search-results');
      const spotifySearchList = document.getElementById('spotify-search-results');
      youtubeSearchList.innerHTML = '';
      spotifySearchList.innerHTML = '';
      videos = [...data.youtube_videos, ...data.spotify_tracks];

      data.youtube_videos.forEach((video, index) => {
        const li = document.createElement('li');
        li.innerHTML = `
          <span>${DOMPurify.sanitize(video.title)} (${video.duration})</span>
          <div class="video-actions">
            <button class="play-button" data-index="${index}" data-source="youtube-search" aria-label="Play ${video.title}"><i class="fas fa-play"></i></button>
            <button class="like-button" data-video='${JSON.stringify(video)}' aria-label="Like ${video.title}"><i class="fas fa-heart"></i></button>
          </div>
        `;
        youtubeSearchList.appendChild(li);
      });

      data.spotify_tracks.forEach((track, index) => {
        const li = document.createElement('li');
        li.innerHTML = `
          <span>${DOMPurify.sanitize(track.title)} (${track.duration})</span>
          <div class="video-actions">
            <button class="play-button" data-index="${index}" data-source="spotify-search" aria-label="Play ${track.title}"><i class="fas fa-play"></i></button>
          </div>
        `;
        spotifySearchList.appendChild(li);
      });

      document.querySelector('.search-results').style.display = 'block';
      document.querySelector('.video-list').style.display = 'none';
      if (videos.length > 0) {
        document.querySelector('.player-section').style.display = 'block';
      }
      attachPlayButtonListeners();
      attachLikeButtonListeners();
    }

    function updateUI(data) {
      document.getElementById('emotion').innerText = DOMPurify.sanitize(data.emotion);
      document.getElementById('emotion-class').innerText = DOMPurify.sanitize(data.emotion);
      document.querySelector('.result-section').style.display = 'block';

      const youtubeVideoList = document.getElementById('youtube-video-list');
      const spotifyTrackList = document.getElementById('spotify-track-list');
      youtubeVideoList.innerHTML = '';
      spotifyTrackList.innerHTML = '';
      videos = [...data.youtube_videos, ...data.spotify_tracks];

      data.youtube_videos.forEach((video, index) => {
        const li = document.createElement('li');
        li.innerHTML = `
          <span>${DOMPurify.sanitize(video.title)} (${video.duration})</span>
          <div class="video-actions">
            <button class="play-button" data-index="${index}" data-source="youtube" aria-label="Play ${video.title}"><i class="fas fa-play"></i></button>
            <button class="like-button" data-video='${JSON.stringify(video)}' aria-label="Like ${video.title}"><i class="fas fa-heart"></i></button>
          </div>
        `;
        youtubeVideoList.appendChild(li);
      });

      data.spotify_tracks.forEach((track, index) => {
        const adjustedIndex = index + data.youtube_videos.length;
        const li = document.createElement('li');
        li.innerHTML = `
          <span>${DOMPurify.sanitize(track.title)} (${track.duration})</span>
          <div class="video-actions">
            <button class="play-button" data-index="${adjustedIndex}" data-source="spotify" aria-label="Play ${track.title}"><i class="fas fa-play"></i></button>
          </div>
        `;
        spotifyTrackList.appendChild(li);
      });

      document.querySelector('.video-list').style.display = 'block';
      document.querySelector('.search-results').style.display = 'none';
      if (videos.length > 0) {
        document.querySelector('.player-section').style.display = 'block';
        playVideo(0);
      }

      attachPlayButtonListeners();
      attachLikeButtonListeners();
      resetWebcam();
    }

    function attachPlayButtonListeners() {
      document.querySelectorAll('.play-button').forEach(button => {
        button.removeEventListener('click', handlePlayButton); // Prevent duplicate listeners
        button.addEventListener('click', handlePlayButton);
      });
    }

    function handlePlayButton() {
      const index = parseInt(this.getAttribute('data-index'));
      const source = this.getAttribute('data-source');
      if (source === 'youtube' || source === 'spotify') {
        playVideo(index);
      } else {
        playVideoFromSearch(index, source.split('-')[0]);
      }
    }

    function attachLikeButtonListeners() {
      document.querySelectorAll('.like-button').forEach(button => {
        button.removeEventListener('click', handleLikeButton); // Prevent duplicate listeners
        button.addEventListener('click', handleLikeButton);
      });
    }

    function handleLikeButton() {
      const video = JSON.parse(this.getAttribute('data-video'));
      fetch('/like_video', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(video)
      })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            const likedList = document.getElementById('liked-videos');
            const li = document.createElement('li');
            li.innerHTML = `<a href="${video.embed_link}" target="_blank" aria-label="Play ${DOMPurify.sanitize(video.title)}">${DOMPurify.sanitize(video.title)}</a>`;
            likedList.appendChild(li);
            document.querySelector('.liked-videos').style.display = 'block';
          } else {
            alert(data.message || 'Failed to like video');
          }
        })
        .catch(error => {
          console.error('Error liking video:', error);
          alert('Failed to like video');
        });
    }

    function playVideo(index) {
      if (index >= videos.length) index = 0;
      currentVideoIndex = index;
      const video = videos[index];
      const isSpotify = video.source === 'Spotify';

      elements.musicPlayer.src = video.embed_link;
      elements.songTitle.innerText = DOMPurify.sanitize(video.title);
      elements.autoplayNotice.style.display = isSpotify ? 'block' : 'none';

      if (!isSpotify) {
        setTimeout(() => {
          if (!elements.musicPlayer.contentWindow.document.querySelector('video')?.playing) {
            elements.autoplayNotice.style.display = 'block';
          }
        }, 2000);
      }
    }

    function playVideoFromSearch(index, source) {
      const offset = source === 'youtube' ? 0 : document.getElementById('youtube-search-results').children.length;
      const videoData = videos[index + offset];
      if (videoData && videoData.embed_link) {
        const isSpotify = videoData.source === 'Spotify';
        elements.musicPlayer.src = videoData.embed_link;
        elements.songTitle.innerText = DOMPurify.sanitize(videoData.title);
        document.querySelector('.player-section').style.display = 'block';
        elements.autoplayNotice.style.display = isSpotify ? 'block' : 'none';
        if (!isSpotify) {
          setTimeout(() => {
            if (!elements.musicPlayer.contentWindow.document.querySelector('video')?.playing) {
              elements.autoplayNotice.style.display = 'block';
            }
          }, 2000);
        }
      } else {
        alert('Unable to play this track. Please try another one.');
      }
    }

    window.addEventListener('message', (event) => {
      if (event.data === 'ENDED') {
        currentVideoIndex++;
        playVideo(currentVideoIndex);
      } else if (event.data?.error) {
        console.error('Playback error:', event.data.error);
        alert(`Failed to play "${DOMPurify.sanitize(videos[currentVideoIndex].title)}". Skipping to the next video.`);
        currentVideoIndex++;
        playVideo(currentVideoIndex);
      }
    });

    elements.themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark-theme');
      document.body.classList.toggle('light-theme');
    });

    elements.resetEmotionHistory.addEventListener('click', () => {
      if (confirm('Are you sure you want to reset emotion history?')) {
        resetEmotionHistory();
      }
    });

    // Initialize
    async function initialize() {
      updateTimer();
      loadTodos();
      initializeEmotionChart();
      try {
        const response = await fetch('/get_emotion_history');
        const data = await response.json();
        if (data.emotion_history) {
          emotionHistory = data.emotion_history;
          localStorage.setItem('emotionHistory', JSON.stringify(emotionHistory));
          updateEmotionChart('none');
        }
      } catch (error) {
        console.error('Error fetching emotion history:', error);
      }
    }

    initialize();
  </script>
</body>
</html>
